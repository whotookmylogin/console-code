var be=Object.defineProperty;var te=A=>{throw TypeError(A)};var Ce=(A,S,b)=>S in A?be(A,S,{enumerable:!0,configurable:!0,writable:!0,value:b}):A[S]=b;var c=(A,S,b)=>Ce(A,typeof S!="symbol"?S+"":S,b),Q=(A,S,b)=>S.has(A)||te("Cannot "+b);var $=(A,S,b)=>(Q(A,S,"read from private field"),b?b.call(A):S.get(A)),U=(A,S,b)=>S.has(A)?te("Cannot add the same private member more than once"):S instanceof WeakSet?S.add(A):S.set(A,b),se=(A,S,b,F)=>(Q(A,S,"write to private field"),F?F.call(A,b):S.set(A,b),b),X=(A,S,b)=>(Q(A,S,"access private method"),b);(function(){"use strict";var z,L,V,R,N,_,re,ie;function A(d){return d}class S{constructor(){c(this,"isInitialized",!1);c(this,"isCapturing",!1);c(this,"logHandler",null);c(this,"originalMethods");c(this,"stackTraceExtractor");c(this,"config",{capturedLevels:["log","info","warn","error","debug"],throttleMs:0,preserveOriginal:!0,cspSafeMode:!1});c(this,"cspRestricted",!1);c(this,"fallbackMethods",new Map);c(this,"lastInterceptTime",new Map);c(this,"interceptedCallsCount",0);c(this,"stackTraceCache",new Map);c(this,"stackTraceCacheSize",100);this.originalMethods={log:console.log.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console),debug:console.debug.bind(console),trace:console.trace.bind(console)},this.stackTraceExtractor=this.createStackTraceExtractor()}async initialize(){if(!this.isInitialized)try{await this.detectCSPRestrictions(),this.config.cspSafeMode=this.cspRestricted,this.cspRestricted&&this.initializeFallbackMethods(),this.setupErrorHandling(),this.isInitialized=!0}catch(e){throw new Error(`Failed to initialize ConsoleInterceptor: ${e instanceof Error?e.message:"Unknown error"}`)}}async startCapture(){if(!this.isInitialized)throw new Error("ConsoleInterceptor not initialized. Call initialize() first.");if(!this.isCapturing)try{this.installInterceptors(),this.isCapturing=!0}catch(e){throw new Error(`Failed to start console capture: ${e instanceof Error?e.message:"Unknown error"}`)}}async stopCapture(){if(this.isCapturing)try{this.restoreOriginalMethods(),this.isCapturing=!1}catch(e){throw new Error(`Failed to stop console capture: ${e instanceof Error?e.message:"Unknown error"}`)}}setLogHandler(e){this.logHandler=e}updateConfig(e){this.config={...this.config,...e},this.isCapturing&&(this.restoreOriginalMethods(),this.installInterceptors())}getStats(){return{interceptedCalls:this.interceptedCallsCount,isCapturing:this.isCapturing,cspRestricted:this.cspRestricted,capturedLevels:this.config.capturedLevels}}async shutdown(){this.isCapturing&&await this.stopCapture(),this.stackTraceCache.clear(),this.lastInterceptTime.clear(),this.isInitialized=!1}installInterceptors(){const e=["log","info","warn","error","debug"];for(const t of e)this.config.capturedLevels.includes(t)&&(console[t]=this.createInterceptor(t))}createInterceptor(e){const t=this.originalMethods[e];return(...s)=>{if(this.config.preserveOriginal)try{t(...s)}catch{}this.handleInterceptedCall(s,e)}}handleInterceptedCall(e,t){try{if(this.shouldThrottle(t))return;this.interceptedCallsCount++,this.lastInterceptTime.set(t,Date.now());const s=this.extractStackTrace();this.logHandler&&setTimeout(()=>{this.logHandler(e,t,s)},0)}catch(s){this.handleInterceptionError(s,t)}}shouldThrottle(e){if(this.config.throttleMs<=0)return!1;const t=this.lastInterceptTime.get(e)||0;return Date.now()-t<this.config.throttleMs}extractStackTrace(){try{return this.cspRestricted?this.stackTraceExtractor.fromError()||this.stackTraceExtractor.fromCaller():this.stackTraceExtractor.fromError()||this.stackTraceExtractor.fromTrace()||this.stackTraceExtractor.fromCaller()}catch{return}}createStackTraceExtractor(){return{fromError:()=>{try{const e=new Error;if(e.stack)return this.cleanStackTrace(e.stack)}catch{}},fromTrace:()=>{try{const e=console.trace;let t="";return console.trace=(...s)=>{t=s.join(" ")},console.trace(),console.trace=e,t||void 0}catch{}},fromCaller:()=>{try{let e=this.extractStackTrace,t="",s=0;for(;e&&e.caller&&s<10;)t+=`at ${e.name||"anonymous"}
`,e=e.caller,s++;return t||void 0}catch{}}}}cleanStackTrace(e){return e.split(`
`).filter(r=>!r.includes("ConsoleInterceptor")&&!r.includes("createInterceptor")&&!r.includes("handleInterceptedCall")&&r.trim().length>0).slice(0,10).join(`
`)}restoreOriginalMethods(){try{console.log=this.originalMethods.log,console.info=this.originalMethods.info,console.warn=this.originalMethods.warn,console.error=this.originalMethods.error,console.debug=this.originalMethods.debug}catch{}}async detectCSPRestrictions(){try{new Error("CSP test").stack||(this.cspRestricted=!0);const t=console.log;console.log=console.log,console.log!==t&&(this.cspRestricted=!0);try{new Function("return 1")()}catch{this.cspRestricted=!0}}catch{this.cspRestricted=!0}}initializeFallbackMethods(){const e=["log","info","warn","error","debug"];for(const t of e)this.fallbackMethods.set(t,(...s)=>{try{this.originalMethods[t](...s)}catch{}})}setupErrorHandling(){typeof window<"u"&&window.addEventListener("error",e=>{var t;e.error&&((t=e.error.message)!=null&&t.includes("ConsoleInterceptor"))&&(this.restoreOriginalMethods(),this.isCapturing=!1)})}handleInterceptionError(e,t){try{this.originalMethods.error("ConsoleInterceptor error:",e);const s=`error_${t}`,r=this[s]||0;this[s]=r+1,r>5&&(this.config.capturedLevels=this.config.capturedLevels.filter(i=>i!==t),console[t]=this.originalMethods[t])}catch{this.restoreOriginalMethods(),this.isCapturing=!1}}}class b{constructor(){c(this,"isInitialized",!1);c(this,"isMonitoring",!1);c(this,"currentSessionId",null);c(this,"config",{enablePerformanceMonitoring:!0,enableNetworkMonitoring:!0,enableUserTracking:!0,maxNetworkRequests:100,maxUserActions:50});c(this,"initialContext",null);c(this,"networkRequests",[]);c(this,"userActions",[]);c(this,"performanceCollector",{paintTiming:[],resourceTiming:[],memoryUsage:[]});c(this,"eventListeners",[]);c(this,"originalFetch");c(this,"originalXHROpen");c(this,"originalXHRSend");c(this,"activeRequests",new Map);c(this,"performanceWorker",null);c(this,"workerSupported",!1);c(this,"memoryMonitorInterval",null);c(this,"cleanupInterval",null);var e;this.originalFetch=((e=window.fetch)==null?void 0:e.bind(window))||(()=>Promise.reject(new Error("fetch not available"))),this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send}async initialize(){if(!this.isInitialized)try{this.workerSupported=this.checkWebWorkerSupport(),this.workerSupported&&await this.initializePerformanceWorker(),this.config.enablePerformanceMonitoring&&this.initializePerformanceMonitoring(),this.startMemoryMonitoring(),this.startPeriodicCleanup(),this.isInitialized=!0}catch(e){throw new Error(`Failed to initialize ContextCollector: ${e instanceof Error?e.message:"Unknown error"}`)}}async collectInitialContext(){if(!this.isInitialized)throw new Error("ContextCollector not initialized. Call initialize() first.");try{const e={url:window.location.href,title:document.title||"Unknown",userAgent:navigator.userAgent,viewport:{width:window.innerWidth||0,height:window.innerHeight||0},versions:{browser:this.detectBrowserVersion(),extension:await this.getExtensionVersion()}};return this.config.enablePerformanceMonitoring&&(e.performance=await this.collectPerformanceMetrics()),this.config.enableNetworkMonitoring&&(e.networkRequests=[]),this.initialContext=e,e}catch(e){throw new Error(`Failed to collect initial context: ${e instanceof Error?e.message:"Unknown error"}`)}}startMonitoring(e){if(!this.isInitialized)throw new Error("ContextCollector not initialized.");this.isMonitoring&&this.stopMonitoring(),this.currentSessionId=e,this.isMonitoring=!0,this.config.enableNetworkMonitoring&&this.startNetworkMonitoring(),this.config.enableUserTracking&&this.startUserActionTracking(),this.startViewportMonitoring(),this.startURLChangeMonitoring()}stopMonitoring(){this.isMonitoring&&(this.removeAllEventListeners(),this.restoreNetworkMethods(),this.stopPerformanceMonitoring(),this.isMonitoring=!1,this.currentSessionId=null)}async getFinalContext(){if(!this.initialContext)throw new Error("No initial context available. Call collectInitialContext() first.");try{const e={...this.initialContext,url:window.location.href,title:document.title||this.initialContext.title,viewport:{width:window.innerWidth||this.initialContext.viewport.width,height:window.innerHeight||this.initialContext.viewport.height}};return this.config.enableNetworkMonitoring&&(e.networkRequests=this.getNetworkRequests()),this.config.enablePerformanceMonitoring&&(e.performance=await this.collectPerformanceMetrics()),e}catch{return this.initialContext}}updateConfig(e){const t={...this.config};if(this.config={...this.config,...e},this.isMonitoring&&(t.enableNetworkMonitoring!==this.config.enableNetworkMonitoring||t.enableUserTracking!==this.config.enableUserTracking||t.enablePerformanceMonitoring!==this.config.enablePerformanceMonitoring)){const s=this.currentSessionId;this.stopMonitoring(),s&&this.startMonitoring(s)}}getStats(){return{isMonitoring:this.isMonitoring,networkRequestsCount:this.networkRequests.length,userActionsCount:this.userActions.length,memoryUsageSamples:this.performanceCollector.memoryUsage.length,workerSupported:this.workerSupported}}async shutdown(){this.isMonitoring&&this.stopMonitoring(),this.performanceWorker&&(this.performanceWorker.terminate(),this.performanceWorker=null),this.memoryMonitorInterval&&(clearInterval(this.memoryMonitorInterval),this.memoryMonitorInterval=null),this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.networkRequests=[],this.userActions=[],this.performanceCollector.paintTiming=[],this.performanceCollector.resourceTiming=[],this.performanceCollector.memoryUsage=[],this.isInitialized=!1}startNetworkMonitoring(){window.fetch=this.createFetchInterceptor(),this.interceptXMLHttpRequest()}createFetchInterceptor(){return async(e,t)=>{const s=e instanceof URL?e.href:typeof e=="string"?e:e.url,r=(t==null?void 0:t.method)||"GET",i=performance.now(),a=`fetch_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;try{const n={url:s,method:r.toUpperCase(),status:0,timestamp:new Date,responseTime:0,failed:!1};this.activeRequests.set(a,{request:n,startTime:i});const o=await this.originalFetch(e,t);return n.status=o.status,n.responseTime=performance.now()-i,n.failed=!o.ok,this.addNetworkRequest(n),this.activeRequests.delete(a),o}catch(n){const o=this.activeRequests.get(a);throw o&&(o.request.responseTime=performance.now()-i,o.request.failed=!0,o.request.status=0,this.addNetworkRequest(o.request),this.activeRequests.delete(a)),n}}}interceptXMLHttpRequest(){const e=this;XMLHttpRequest.prototype.open=function(t,s,r,i,a){const n=typeof s=="string"?s:s.toString(),o=`xhr_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,l=performance.now();return this.__contextCollector={requestId:o,startTime:l,url:n,method:t.toUpperCase()},this.addEventListener("loadend",function(){const h=this.__contextCollector;if(h&&e.isMonitoring){const p={url:h.url,method:h.method,status:this.status,timestamp:new Date(Date.now()-(performance.now()-h.startTime)),responseTime:performance.now()-h.startTime,failed:this.status===0||this.status>=400};e.addNetworkRequest(p)}}),e.originalXHROpen.call(this,t,s,r??!0,i,a)},XMLHttpRequest.prototype.send=function(t){return e.originalXHRSend.call(this,t)}}addNetworkRequest(e){this.networkRequests.push(e),this.networkRequests.length>this.config.maxNetworkRequests&&this.networkRequests.shift()}startUserActionTracking(){this.addEventListener(document,"click",t=>{this.trackUserAction("click",t)},{passive:!0});let e=null;this.addEventListener(window,"scroll",()=>{e&&clearTimeout(e),e=setTimeout(()=>{this.trackUserAction("scroll",{scrollX:window.scrollX,scrollY:window.scrollY})},100)},{passive:!0}),this.addEventListener(document,"keydown",t=>{const s=t;(s.key==="Enter"||s.key==="Escape"||s.key==="Tab")&&this.trackUserAction("keypress",{key:s.key,ctrlKey:s.ctrlKey,shiftKey:s.shiftKey,altKey:s.altKey})},{passive:!0}),this.addEventListener(document,"submit",t=>{this.trackUserAction("submit",t)},{passive:!0}),this.addEventListener(document,"visibilitychange",()=>{this.trackUserAction("visibility-change",{visibilityState:document.visibilityState})},{passive:!0})}trackUserAction(e,t){var s;try{const r={type:e,target:{tagName:"unknown"},timestamp:new Date};if(t&&t.target){const i=t.target;r.target={tagName:i.tagName||"unknown"},i.id&&(r.target.id=i.id),i.className&&(r.target.className=i.className);const a=(s=i.textContent)==null?void 0:s.substring(0,50);a&&(r.target.textContent=a),e==="click"&&"clientX"in t&&"clientY"in t&&(r.coordinates={x:t.clientX,y:t.clientY})}else t&&(r.metadata=t);this.userActions.push(r),this.userActions.length>this.config.maxUserActions&&this.userActions.shift()}catch{}}startViewportMonitoring(){let e=null;this.addEventListener(window,"resize",()=>{e&&clearTimeout(e),e=setTimeout(()=>{this.initialContext&&(this.initialContext.viewport={width:window.innerWidth||0,height:window.innerHeight||0})},100)},{passive:!0}),this.addEventListener(window,"orientationchange",()=>{setTimeout(()=>{this.initialContext&&(this.initialContext.viewport={width:window.innerWidth||0,height:window.innerHeight||0})},500)},{passive:!0})}startURLChangeMonitoring(){const e=history.pushState,t=history.replaceState;history.pushState=(...s)=>{e.apply(history,s),this.handleURLChange()},history.replaceState=(...s)=>{t.apply(history,s),this.handleURLChange()},this.addEventListener(window,"popstate",()=>{this.handleURLChange()},{passive:!0}),this.__originalPushState=e,this.__originalReplaceState=t}handleURLChange(){if(this.initialContext){const e=window.location.href;e!==this.initialContext.url&&(this.initialContext.url=e,this.initialContext.title=document.title||this.initialContext.title,this.trackUserAction("navigation",{url:e,title:document.title}))}}initializePerformanceMonitoring(){try{if("PerformanceObserver"in window){this.performanceCollector.observer=new PerformanceObserver(t=>{this.handlePerformanceEntries(t.getEntries())});const e=["navigation","paint","resource","largest-contentful-paint"];for(const t of e)try{this.performanceCollector.observer.observe({entryTypes:[t]})}catch{}}if("performance"in window&&window.performance.getEntriesByType){const e=window.performance.getEntriesByType("navigation");e.length>0&&(this.performanceCollector.navigationTiming=e[0])}}catch{}}handlePerformanceEntries(e){for(const t of e)switch(t.entryType){case"paint":this.performanceCollector.paintTiming.push(t);break;case"resource":this.performanceCollector.resourceTiming.push(t),this.performanceCollector.resourceTiming.length>200&&this.performanceCollector.resourceTiming.splice(0,50);break;case"largest-contentful-paint":this.performanceCollector.paintTiming=this.performanceCollector.paintTiming.filter(s=>s.entryType!=="largest-contentful-paint"),this.performanceCollector.paintTiming.push(t);break}}async collectPerformanceMetrics(){const e={};try{for(const t of this.performanceCollector.paintTiming)switch(t.name){case"first-contentful-paint":e.fcp=t.startTime;break;case"largest-contentful-paint":e.lcp=t.startTime;break}if(this.performanceCollector.navigationTiming){const t=this.performanceCollector.navigationTiming;e.tti=t.domInteractive-(t.fetchStart||0)}if("memory"in performance&&performance.memory){const t=performance.memory;e.memory={used:t.usedJSHeapSize,total:t.totalJSHeapSize}}else if(this.performanceCollector.memoryUsage.length>0){const t=this.performanceCollector.memoryUsage[this.performanceCollector.memoryUsage.length-1];t&&(e.memory={used:t.usage,total:t.usage*2})}this.performanceCollector.resourceTiming.length>0&&(e.cls=0),this.userActions.some(t=>["click","keypress"].includes(t.type))&&(e.fid=0)}catch{}return e}getNetworkRequests(){return[...this.networkRequests]}startMemoryMonitoring(){this.memoryMonitorInterval=setInterval(()=>{try{if("memory"in performance&&performance.memory){const e=performance.memory;this.performanceCollector.memoryUsage.push({timestamp:new Date,usage:e.usedJSHeapSize}),this.performanceCollector.memoryUsage.length>100&&this.performanceCollector.memoryUsage.splice(0,20)}}catch{}},1e4)}startPeriodicCleanup(){this.cleanupInterval=setInterval(()=>{this.performCleanup()},6e4)}performCleanup(){const e=Date.now(),t=5*60*1e3;this.userActions=this.userActions.filter(s=>e-s.timestamp.getTime()<t),this.networkRequests=this.networkRequests.filter(s=>e-s.timestamp.getTime()<t),this.performanceCollector.memoryUsage=this.performanceCollector.memoryUsage.filter(s=>e-s.timestamp.getTime()<t)}checkWebWorkerSupport(){try{return typeof Worker<"u"&&typeof Blob<"u"}catch{return!1}}async initializePerformanceWorker(){if(this.workerSupported)try{const e=`
        self.onmessage = function(e) {
          const { type, data } = e.data;
          
          switch (type) {
            case 'calculateMetrics':
              // Perform heavy metric calculations
              const result = performMetricCalculations(data);
              self.postMessage({ type: 'metricsResult', data: result });
              break;
              
            case 'processNetworkData':
              // Process network request data
              const processed = processNetworkRequests(data);
              self.postMessage({ type: 'networkProcessed', data: processed });
              break;
              
            default:
              self.postMessage({ type: 'error', data: 'Unknown message type' });
          }
        };
        
        function performMetricCalculations(data) {
          // Placeholder for complex metric calculations
          return { processed: true, timestamp: Date.now() };
        }
        
        function processNetworkRequests(data) {
          // Placeholder for network data processing
          return { processed: data.length, timestamp: Date.now() };
        }
      `,t=new Blob([e],{type:"application/javascript"});this.performanceWorker=new Worker(URL.createObjectURL(t)),this.performanceWorker.onmessage=s=>{this.handleWorkerMessage(s.data)},this.performanceWorker.onerror=s=>{var r;console.warn("Performance worker error:",s),(r=this.performanceWorker)==null||r.terminate(),this.performanceWorker=null}}catch{this.workerSupported=!1}}handleWorkerMessage(e){switch(e.type){case"metricsResult":break;case"networkProcessed":break;case"error":console.warn("Worker error:",e.data);break}}stopPerformanceMonitoring(){this.performanceCollector.observer&&(this.performanceCollector.observer.disconnect(),delete this.performanceCollector.observer)}restoreNetworkMethods(){try{window.fetch=this.originalFetch,XMLHttpRequest.prototype.open=this.originalXHROpen,XMLHttpRequest.prototype.send=this.originalXHRSend,this.__originalPushState&&(history.pushState=this.__originalPushState),this.__originalReplaceState&&(history.replaceState=this.__originalReplaceState)}catch{}}addEventListener(e,t,s,r){e.addEventListener(t,s,r),this.eventListeners.push({target:e,event:t,handler:s,options:r||{}})}removeAllEventListeners(){for(const e of this.eventListeners)try{e.target.removeEventListener(e.event,e.handler,e.options)}catch{}this.eventListeners=[]}detectBrowserVersion(){const e=navigator.userAgent;if(e.includes("Chrome/")){const t=e.match(/Chrome\/(\d+\.\d+)/);return t?`Chrome ${t[1]}`:"Chrome Unknown"}else if(e.includes("Firefox/")){const t=e.match(/Firefox\/(\d+\.\d+)/);return t?`Firefox ${t[1]}`:"Firefox Unknown"}else if(e.includes("Safari/")){const t=e.match(/Version\/(\d+\.\d+)/);return t?`Safari ${t[1]}`:"Safari Unknown"}else if(e.includes("Edge/")){const t=e.match(/Edge\/(\d+\.\d+)/);return t?`Edge ${t[1]}`:"Edge Unknown"}return"Unknown Browser"}async getExtensionVersion(){try{if(typeof chrome<"u"&&chrome.runtime&&chrome.runtime.getManifest)return chrome.runtime.getManifest().version||"1.0.0";if(typeof fetch<"u")try{return(await(await fetch("/package.json")).json()).version||"1.0.0"}catch{}return"1.0.0"}catch{return"1.0.0"}}}class F{constructor(e,t){c(this,"currentSession",null);c(this,"consoleInterceptor");c(this,"contextCollector");c(this,"eventBus");c(this,"securityEngine");c(this,"config",null);c(this,"isInitialized",!1);c(this,"performanceThresholds",{maxCaptureLatencyMs:2,maxMemoryMB:50,throttleThresholdMs:100,maxLogsPerSecond:1e3});c(this,"captureStats",{totalLogs:0,logsPerSecond:0,averageCaptureLatency:0,currentMemoryMB:0,throttledCaptures:0});c(this,"lastCaptureTime",0);c(this,"recentCaptureTimes",[]);c(this,"throttleTimer",null);c(this,"pendingLogs",[]);c(this,"memoryMonitorInterval",null);c(this,"performanceObserver",null);this.eventBus=e,this.securityEngine=t,this.consoleInterceptor=new S,this.contextCollector=new b}async initialize(){var e;try{await this.consoleInterceptor.initialize(),await this.contextCollector.initialize(),this.consoleInterceptor.setLogHandler(this.handleCapturedLog.bind(this)),this.startPerformanceMonitoring(),this.setupCleanupHandlers(),this.isInitialized=!0,(e=this.eventBus)==null||e.emit("capture:engine-initialized",{timestamp:new Date})}catch(t){throw{name:"CaptureEngineInitError",message:`Failed to initialize capture engine: ${t instanceof Error?t.message:"Unknown error"}`,code:"CAPTURE_ENGINE_INIT_FAILED",severity:"critical",reportable:!0,context:{originalError:t}}}}async startSession(){var e;if(this.ensureInitialized(),this.currentSession)throw new Error("Capture session already active. Stop current session first.");try{const t=await this.contextCollector.collectInitialContext();return this.currentSession={id:this.generateSessionId(),startTime:new Date,logs:[],context:t,metadata:{totalLogs:0,errorCount:0,warningCount:0,containsSensitiveData:!1,tags:[]}},await this.consoleInterceptor.startCapture(),this.currentSession&&this.contextCollector.startMonitoring(this.currentSession.id),this.resetCaptureStats(),this.currentSession&&((e=this.eventBus)==null||e.emit("capture:session-started",{sessionId:this.currentSession.id,timestamp:this.currentSession.startTime})),this.currentSession}catch(t){throw this.currentSession=null,{name:"SessionStartError",message:`Failed to start capture session: ${t instanceof Error?t.message:"Unknown error"}`,code:"SESSION_START_FAILED",severity:"high",reportable:!0,context:{originalError:t}}}}async stopSession(){var e,t;if(this.ensureInitialized(),!this.currentSession)return null;try{await this.consoleInterceptor.stopCapture(),this.contextCollector.stopMonitoring(),await this.processPendingLogs(),this.currentSession.endTime=new Date,this.currentSession.context=await this.contextCollector.getFinalContext(),this.currentSession&&(this.currentSession.context.performance=await this.getPerformanceMetrics());const s={...this.currentSession};return this.currentSession=null,(e=this.eventBus)==null||e.emit("capture:session-stopped",{sessionId:s.id,endTime:s.endTime,totalLogs:s.logs.length}),s}catch(s){throw{name:"SessionStopError",message:`Failed to stop capture session: ${s instanceof Error?s.message:"Unknown error"}`,code:"SESSION_STOP_FAILED",severity:"medium",reportable:!0,context:{originalError:s,sessionId:(t=this.currentSession)==null?void 0:t.id}}}}getCurrentSession(){return this.currentSession}isCapturing(){return this.currentSession!==null}updateConfig(e){var t,s;this.config=e,e.performance&&(this.performanceThresholds.maxMemoryMB=e.performance.maxMemoryMB,this.performanceThresholds.throttleThresholdMs=e.performance.throttleMs),this.consoleInterceptor.updateConfig({capturedLevels:e.capturedLevels,throttleMs:((t=e.performance)==null?void 0:t.throttleMs)||0}),this.contextCollector.updateConfig({enablePerformanceMonitoring:((s=e.performance)==null?void 0:s.enableMonitoring)||!1})}getCaptureStats(){return{...this.captureStats}}async handleCapturedLog(e,t,s){var i,a,n,o;if(!this.currentSession)return;const r=performance.now();try{if(this.shouldThrottle()){this.captureStats.throttledCaptures++,this.queueForThrottledProcessing(e,t,s);return}const l=await this.createLogEntry(e,t,s);(i=this.config)!=null&&i.privacy.enablePIIDetection&&await this.scanForPII(l),this.addLogToSession(l);const h=performance.now()-r;this.updateCaptureStats(h),this.checkPerformanceThresholds(h),(a=this.eventBus)==null||a.emit("capture:log-captured",{sessionId:this.currentSession.id,logId:l.id,level:l.level})}catch(l){(o=this.eventBus)==null||o.emit("capture:log-capture-failed",{sessionId:(n=this.currentSession)==null?void 0:n.id,error:l instanceof Error?l.message:"Unknown error"})}}async createLogEntry(e,t,s){const r=e.map(n=>{if(typeof n=="object"&&n!==null)try{return JSON.stringify(n,null,2)}catch{return String(n)}return String(n)}).join(" "),i=this.extractSourceLocation(s),a={id:this.generateLogId(),timestamp:new Date,level:t,message:r};return i&&(a.source=i),s&&(a.stackTrace=s),a}async scanForPII(e){var t,s,r;if(this.securityEngine)try{const i=await this.securityEngine.classifyData(e.message);e.classification=i,i.sanitized&&(e.sanitizedMessage=await this.securityEngine.sanitizeData(e.message),this.currentSession&&(this.currentSession.metadata.containsSensitiveData=!0),(s=this.eventBus)==null||s.emit("security:pii-detected",{sessionId:(t=this.currentSession)==null?void 0:t.id,logId:e.id,piiTypes:i.detectedTypes}))}catch(i){(r=this.eventBus)==null||r.emit("security:classification-failed",{logId:e.id,error:i instanceof Error?i.message:"Unknown error"})}}addLogToSession(e){if(this.currentSession)switch(this.currentSession.logs.push(e),this.currentSession.metadata.totalLogs++,e.level){case"error":this.currentSession.metadata.errorCount++;break;case"warn":this.currentSession.metadata.warningCount++;break}}shouldThrottle(){const e=Date.now();return e-this.lastCaptureTime<this.performanceThresholds.throttleThresholdMs||(this.recentCaptureTimes=this.recentCaptureTimes.filter(t=>e-t<1e3),this.recentCaptureTimes.push(e),this.recentCaptureTimes.length>this.performanceThresholds.maxLogsPerSecond)?!0:(this.lastCaptureTime=e,!1)}queueForThrottledProcessing(e,t,s){this.throttleTimer||(this.throttleTimer=setTimeout(()=>{this.processThrottledLogs(),this.throttleTimer=null},this.performanceThresholds.throttleThresholdMs))}async processThrottledLogs(){}async processPendingLogs(){this.throttleTimer&&(clearTimeout(this.throttleTimer),this.throttleTimer=null),await this.processThrottledLogs()}updateCaptureStats(e){this.captureStats.totalLogs++;const t=.1;this.captureStats.averageCaptureLatency=(1-t)*this.captureStats.averageCaptureLatency+t*e,this.captureStats.logsPerSecond=this.recentCaptureTimes.length,this.updateMemoryUsage()}updateMemoryUsage(){if("memory"in performance&&performance.memory){const e=performance.memory;this.captureStats.currentMemoryMB=e.usedJSHeapSize/(1024*1024)}}checkPerformanceThresholds(e){var t,s;e>this.performanceThresholds.maxCaptureLatencyMs&&((t=this.eventBus)==null||t.emit("capture:performance-warning",{type:"high-latency",value:e,threshold:this.performanceThresholds.maxCaptureLatencyMs})),this.captureStats.currentMemoryMB>this.performanceThresholds.maxMemoryMB&&((s=this.eventBus)==null||s.emit("capture:performance-warning",{type:"high-memory",value:this.captureStats.currentMemoryMB,threshold:this.performanceThresholds.maxMemoryMB}),this.triggerMemoryCleanup())}triggerMemoryCleanup(){var e;if(this.currentSession&&this.currentSession.logs.length>1e3){const t=Math.floor(this.currentSession.logs.length*.1);this.currentSession.logs.splice(0,t),(e=this.eventBus)==null||e.emit("capture:memory-cleanup",{sessionId:this.currentSession.id,removedLogs:t})}}startPerformanceMonitoring(){if(this.memoryMonitorInterval=setInterval(()=>{this.updateMemoryUsage(),this.checkPerformanceThresholds(0)},5e3),"PerformanceObserver"in window)try{this.performanceObserver=new PerformanceObserver(e=>{const t=e.getEntries();for(const s of t)s.name.includes("console-capture")&&this.checkPerformanceThresholds(s.duration)}),this.performanceObserver.observe({entryTypes:["measure"]})}catch(e){console.warn("PerformanceObserver initialization failed:",e)}}setupCleanupHandlers(){typeof window<"u"&&(window.addEventListener("beforeunload",()=>{this.cleanup()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this.cleanup()}))}cleanup(){this.throttleTimer&&(clearTimeout(this.throttleTimer),this.throttleTimer=null),this.memoryMonitorInterval&&(clearInterval(this.memoryMonitorInterval),this.memoryMonitorInterval=null),this.performanceObserver&&(this.performanceObserver.disconnect(),this.performanceObserver=null)}async shutdown(){this.isInitialized&&(this.currentSession&&await this.stopSession(),await this.consoleInterceptor.shutdown(),await this.contextCollector.shutdown(),this.cleanup(),this.isInitialized=!1)}async getPerformanceMetrics(){const e={};try{if("performance"in window&&window.performance.getEntriesByType){const t=window.performance.getEntriesByType("paint");for(const r of t)r.name==="first-contentful-paint"&&(e.fcp=r.startTime);const s=window.performance.getEntriesByType("navigation");if(s.length>0){const r=s[0];e.tti=r.domInteractive-(r.fetchStart||0)}if("memory"in performance&&performance.memory){const r=performance.memory;e.memory={used:r.usedJSHeapSize,total:r.totalJSHeapSize}}}}catch{}return e}resetCaptureStats(){this.captureStats={totalLogs:0,logsPerSecond:0,averageCaptureLatency:0,currentMemoryMB:0,throttledCaptures:0},this.recentCaptureTimes=[],this.lastCaptureTime=0}extractSourceLocation(e){if(!e)return;const t=e.match(/at .+? \((.+?):(\d+):(\d+)\)/);if(t&&t[1]&&t[2]&&t[3])return{file:t[1],line:parseInt(t[2],10),column:parseInt(t[3],10)}}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}generateLogId(){return`log_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}ensureInitialized(){if(!this.isInitialized)throw new Error("CaptureEngine not initialized. Call initialize() first.")}}class ne{constructor(){c(this,"subscriptions",new Map);c(this,"subscriptionIdCounter",0);c(this,"eventQueue",[]);c(this,"isProcessingQueue",!1);c(this,"stats",{totalEventsEmitted:0,totalListeners:0,eventCounts:{},averageProcessingTime:0,failedEvents:0});c(this,"processingTimes",[]);c(this,"maxQueueSize",1e3);c(this,"defaultTimeout",5e3);c(this,"debugMode",process.env.NODE_ENV==="development");this.startQueueProcessor()}on(e,t,s={}){const r={id:`sub_${++this.subscriptionIdCounter}`,eventName:e,listener:t,once:s.once||!1,priority:s.priority||0,created:new Date};this.subscriptions.has(e)||this.subscriptions.set(e,[]);const i=this.subscriptions.get(e);return i.push(r),i.sort((a,n)=>n.priority-a.priority),this.stats.totalListeners++,this.debugMode&&console.debug(`[EventBus] Subscribed to '${e}' (ID: ${r.id}, Priority: ${r.priority})`),()=>this.unsubscribe(r.id)}once(e,t,s={}){return this.on(e,t,{...s,once:!0})}emit(e,t,s={}){const r=performance.now();this.stats.totalEventsEmitted++,this.stats.eventCounts[e]=(this.stats.eventCounts[e]||0)+1,this.debugMode&&console.debug(`[EventBus] Emitting '${e}'`,t);const i=this.subscriptions.get(e)||[];if(i.length===0){this.debugMode&&console.debug(`[EventBus] No listeners for '${e}'`);return}s.async?this.queueEvent(e,t,s.timeout):this.processEventSync(e,t,i,r,s.timeout)}async emitAsync(e,t,s){const r=performance.now();this.stats.totalEventsEmitted++,this.stats.eventCounts[e]=(this.stats.eventCounts[e]||0)+1,this.debugMode&&console.debug(`[EventBus] Emitting async '${e}'`,t);const i=this.subscriptions.get(e)||[];i.length!==0&&await this.processEventAsync(e,t,i,r,s)}unsubscribe(e){for(const[t,s]of this.subscriptions.entries()){const r=s.findIndex(i=>i.id===e);if(r!==-1)return s.splice(r,1),this.stats.totalListeners--,s.length===0&&this.subscriptions.delete(t),this.debugMode&&console.debug(`[EventBus] Unsubscribed from '${t}' (ID: ${e})`),!0}return!1}removeAllListeners(e){if(e){const s=(this.subscriptions.get(e)||[]).length;return this.subscriptions.delete(e),this.stats.totalListeners-=s,this.debugMode&&console.debug(`[EventBus] Removed ${s} listeners for '${e}'`),s}else{const t=this.stats.totalListeners;return this.subscriptions.clear(),this.stats.totalListeners=0,this.debugMode&&console.debug(`[EventBus] Removed all ${t} listeners`),t}}listenerCount(e){const t=this.subscriptions.get(e);return t?t.length:0}eventNames(){return Array.from(this.subscriptions.keys())}getStats(){return{...this.stats}}resetStats(){this.stats={totalEventsEmitted:0,totalListeners:this.stats.totalListeners,eventCounts:{},averageProcessingTime:0,failedEvents:0},this.processingTimes=[]}setDebugMode(e){this.debugMode=e,this.debugMode&&console.debug("[EventBus] Debug mode enabled")}getQueueSize(){return this.eventQueue.length}clearQueue(){const e=this.eventQueue.length;return this.eventQueue=[],this.debugMode&&console.debug(`[EventBus] Cleared ${e} queued events`),e}processEventSync(e,t,s,r,i){const a=[];for(const n of s)try{const o=n.listener(t);if(o instanceof Promise){const l=i||this.defaultTimeout;Promise.race([o,new Promise((h,p)=>setTimeout(()=>p(new Error("Listener timeout")),l))]).catch(h=>{this.handleListenerError(e,n,h)})}n.once&&a.push(n.id)}catch(o){this.handleListenerError(e,n,o)}a.forEach(n=>this.unsubscribe(n)),this.updateProcessingTime(performance.now()-r)}async processEventAsync(e,t,s,r,i){const a=[],n=i||this.defaultTimeout,o=s.map(async l=>{try{const h=Promise.resolve(l.listener(t));await Promise.race([h,new Promise((p,w)=>setTimeout(()=>w(new Error("Listener timeout")),n))]),l.once&&a.push(l.id)}catch(h){this.handleListenerError(e,l,h)}});await Promise.allSettled(o),a.forEach(l=>this.unsubscribe(l)),this.updateProcessingTime(performance.now()-r)}queueEvent(e,t,s){this.eventQueue.length>=this.maxQueueSize&&(this.eventQueue.shift(),this.debugMode&&console.warn("[EventBus] Event queue full, dropping oldest event")),this.eventQueue.push({eventName:e,payload:t,timestamp:new Date,retryCount:0,maxRetries:3})}startQueueProcessor(){setInterval(async()=>{if(!(this.isProcessingQueue||this.eventQueue.length===0)){for(this.isProcessingQueue=!0;this.eventQueue.length>0;){const t=this.eventQueue.shift();try{const s=this.subscriptions.get(t.eventName)||[];await this.processEventAsync(t.eventName,t.payload,s,performance.now())}catch(s){t.retryCount++,t.retryCount<t.maxRetries?this.eventQueue.push(t):(this.stats.failedEvents++,this.stats.lastError={event:t.eventName,error:s instanceof Error?s.message:"Unknown error",timestamp:new Date},this.debugMode&&console.error(`[EventBus] Failed to process queued event '${t.eventName}' after ${t.maxRetries} retries:`,s))}}this.isProcessingQueue=!1}},100)}handleListenerError(e,t,s){if(this.stats.failedEvents++,this.stats.lastError={event:e,error:s instanceof Error?s.message:"Unknown error",timestamp:new Date},this.debugMode&&console.error(`[EventBus] Listener error for '${e}' (ID: ${t.id}):`,s),e!=="extension:error")try{this.emit("extension:error",{name:"EventListenerError",message:`Listener failed for event '${e}': ${s instanceof Error?s.message:"Unknown error"}`,code:"EVENT_LISTENER_FAILED",severity:"low",reportable:!1,context:{eventName:e,subscriptionId:t.id,originalError:s}})}catch{}}updateProcessingTime(e){this.processingTimes.push(e),this.processingTimes.length>100&&(this.processingTimes=this.processingTimes.slice(-100)),this.stats.averageProcessingTime=this.processingTimes.reduce((t,s)=>t+s,0)/this.processingTimes.length}}class oe{constructor(){c(this,"patterns");c(this,"customPatterns");c(this,"performanceMetrics");this.patterns=new Map,this.customPatterns=[],this.performanceMetrics={totalScans:0,totalScanTimeMs:0,averageScanTimeMs:0,lastScanTimeMs:0},this.initializeDefaultPatterns()}scanText(e,t=.7){const s=performance.now(),r=[];try{for(const[a,n]of this.patterns)for(const o of n){const l=this.findPatternMatches(e,o);r.push(...l.filter(h=>h.confidence>=t))}for(const a of this.customPatterns){const n=this.findPatternMatches(e,a);r.push(...n.filter(o=>o.confidence>=t))}return this.removeOverlappingDetections(r)}finally{const i=performance.now()-s;this.updatePerformanceMetrics(i)}}addCustomPattern(e){if(!e.pattern||!e.name||!e.type)throw new Error("Invalid PII pattern: missing required fields");try{e.pattern.test("test")}catch(t){throw new Error(`Invalid regex pattern: ${t}`)}this.customPatterns.push({...e,pattern:new RegExp(e.pattern.source,"gi")})}removeCustomPattern(e){this.customPatterns.length;const t=this.customPatterns.findIndex(s=>s.name===e);return t!==-1?(this.customPatterns.splice(t,1),!0):!1}getPerformanceMetrics(){return{...this.performanceMetrics}}resetPerformanceMetrics(){this.performanceMetrics.totalScans=0,this.performanceMetrics.totalScanTimeMs=0,this.performanceMetrics.averageScanTimeMs=0,this.performanceMetrics.lastScanTimeMs=0}getSupportedPIITypes(){const e=new Set;for(const t of this.patterns.keys())e.add(t);for(const t of this.customPatterns)e.add(t.type);return Array.from(e)}findPatternMatches(e,t){const s=[];let r;for(t.pattern.lastIndex=0;(r=t.pattern.exec(e))!==null;){const i=r[0];let a=t.baseConfidence;if(t.validator){if(!t.validator(i))continue;a=Math.min(1,a+.1)}if(t.requiresContext){const o=this.validateContext(e,r.index,i,t.type);a=a*o}a=this.applyTypeSpecificValidation(i,t.type,a);const n={type:t.type,value:i,startIndex:r.index,endIndex:r.index+i.length,confidence:a,patternName:t.name,highConfidence:a>=.8};s.push(n),r[0].length===0&&t.pattern.lastIndex++}return s}validateContext(e,t,s,r){const a=Math.max(0,t-20),n=Math.min(e.length,t+s.length+20),o=e.substring(a,n).toLowerCase();switch(r){case"email":return o.includes("email")||o.includes("mail")||o.includes("@")?1:o.includes("user")||o.includes("login")||o.includes("account")?.9:.8;case"creditCard":return o.includes("card")||o.includes("payment")||o.includes("visa")||o.includes("mastercard")||o.includes("amex")?1:o.includes("number")||o.includes("cc")||o.includes("credit")?.9:.7;case"ssn":return o.includes("ssn")||o.includes("social")||o.includes("security")?1:o.includes("tax")||o.includes("id")||o.includes("number")?.8:.6;case"phone":return o.includes("phone")||o.includes("tel")||o.includes("call")||o.includes("mobile")||o.includes("contact")?1:.8;case"apiKey":case"jwt":return o.includes("key")||o.includes("token")||o.includes("auth")||o.includes("api")||o.includes("bearer")?1:.8;default:return .8}}applyTypeSpecificValidation(e,t,s){switch(t){case"creditCard":return this.validateCreditCard(e)?s:s*.5;case"email":return this.validateEmail(e)?s:s*.3;case"ssn":return this.validateSSN(e)?s:s*.2;case"phone":return this.validatePhone(e)?s:s*.6;default:return s}}validateCreditCard(e){const t=e.replace(/\D/g,"");if(t.length<13||t.length>19)return!1;let s=0,r=!1;for(let i=t.length-1;i>=0;i--){let a=parseInt(t.charAt(i),10);r&&(a*=2,a>9&&(a=a%10+1)),s+=a,r=!r}return s%10===0}validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)&&!e.includes("..")}validateSSN(e){const t=e.replace(/\D/g,""),s=["000","666","900","999","0000","00"];if(t.length!==9)return!1;const r=t.substring(0,3),i=t.substring(3,5),a=t.substring(5,9);return!s.includes(r)&&!s.includes(i)&&!s.includes(a)}validatePhone(e){const t=e.replace(/\D/g,"");return t.length>=10&&t.length<=15}removeOverlappingDetections(e){if(e.length<=1)return e;const t=e.sort((r,i)=>r.confidence!==i.confidence?i.confidence-r.confidence:r.startIndex-i.startIndex),s=[];for(const r of t)s.some(a=>!(r.endIndex<=a.startIndex||r.startIndex>=a.endIndex))||s.push(r);return s.sort((r,i)=>r.startIndex-i.startIndex)}updatePerformanceMetrics(e){this.performanceMetrics.lastScanTimeMs=e,this.performanceMetrics.totalScans++,this.performanceMetrics.totalScanTimeMs+=e,this.performanceMetrics.averageScanTimeMs=this.performanceMetrics.totalScanTimeMs/this.performanceMetrics.totalScans}initializeDefaultPatterns(){this.addPatternToType("creditCard",[{name:"visa",type:"creditCard",pattern:/\b4\d{3}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/gi,baseConfidence:.9,requiresContext:!0,description:"Visa credit card number"},{name:"mastercard",type:"creditCard",pattern:/\b5[1-5]\d{2}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/gi,baseConfidence:.9,requiresContext:!0,description:"Mastercard credit card number"},{name:"amex",type:"creditCard",pattern:/\b3[47]\d{2}[\s-]?\d{6}[\s-]?\d{5}\b/gi,baseConfidence:.9,requiresContext:!0,description:"American Express credit card number"},{name:"discover",type:"creditCard",pattern:/\b6(?:011|5\d{2})[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/gi,baseConfidence:.9,requiresContext:!0,description:"Discover credit card number"}]),this.addPatternToType("ssn",[{name:"ssn_standard",type:"ssn",pattern:/\b\d{3}[-.\s]?\d{2}[-.\s]?\d{4}\b/gi,baseConfidence:.8,requiresContext:!0,description:"Social Security Number"}]),this.addPatternToType("email",[{name:"email_standard",type:"email",pattern:/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/gi,baseConfidence:.95,requiresContext:!1,description:"Email address"}]),this.addPatternToType("phone",[{name:"us_phone",type:"phone",pattern:/\b(?:\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})\b/gi,baseConfidence:.85,requiresContext:!0,description:"US phone number"},{name:"international_phone",type:"phone",pattern:/\+(?:[0-9] ?){6,14}[0-9]/gi,baseConfidence:.8,requiresContext:!0,description:"International phone number"}]),this.addPatternToType("ipAddress",[{name:"ipv4",type:"ipAddress",pattern:/\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/gi,baseConfidence:.9,requiresContext:!1,description:"IPv4 address"},{name:"ipv6",type:"ipAddress",pattern:/\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b/gi,baseConfidence:.9,requiresContext:!1,description:"IPv6 address"}]),this.addPatternToType("apiKey",[{name:"generic_api_key",type:"apiKey",pattern:/\b[A-Za-z0-9]{32,}\b/gi,validator:e=>e.length>=32&&/[A-Z]/.test(e)&&/[a-z]/.test(e)&&/[0-9]/.test(e),baseConfidence:.7,requiresContext:!0,description:"Generic API key"},{name:"aws_access_key",type:"apiKey",pattern:/\bAKIA[0-9A-Z]{16}\b/gi,baseConfidence:.95,requiresContext:!1,description:"AWS Access Key"},{name:"github_token",type:"apiKey",pattern:/\bghp_[0-9a-zA-Z]{36}\b/gi,baseConfidence:.95,requiresContext:!1,description:"GitHub Personal Access Token"}]),this.addPatternToType("jwt",[{name:"jwt_token",type:"jwt",pattern:/\beyJ[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*\b/gi,validator:e=>{const t=e.split(".");return t.length===3&&t.every(s=>s.length>0)},baseConfidence:.9,requiresContext:!1,description:"JWT token"}]),this.addPatternToType("password",[{name:"password_in_url",type:"password",pattern:/password=([^&\s]+)/gi,baseConfidence:.9,requiresContext:!1,description:"Password in URL parameter"},{name:"password_assignment",type:"password",pattern:/(?:password|pwd|pass)\s*[:=]\s*['"]([^'"]+)['"]/gi,baseConfidence:.8,requiresContext:!1,description:"Password assignment in code"}])}addPatternToType(e,t){this.patterns.has(e)||this.patterns.set(e,[]),this.patterns.get(e).push(...t)}}class ae{constructor(e){c(this,"config");c(this,"auditTrail");c(this,"hashCache");this.config={defaultStrategy:"mask",typeStrategies:{creditCard:"mask",ssn:"mask",email:"partial",phone:"partial",apiKey:"remove",jwt:"remove",password:"remove",ipAddress:"hash",custom:"mask"},maskCharacter:"*",partialPreserveLength:4,preserveFormat:!0,hashSalt:this.generateSalt(),...e},this.auditTrail=[],this.hashCache=new Map}sanitizeText(e,t){if(t.length===0)return{originalText:e,sanitizedText:e,sanitizedDetections:[],actions:[],wasModified:!1};const s=[...t].sort((n,o)=>o.startIndex-n.startIndex);let r=e;const i=[],a=[];for(const n of s){const o=this.getStrategyForPIIType(n.type),l=this.applySanitizationStrategy(n.value,n.type,o),h=r.substring(0,n.startIndex),p=r.substring(n.endIndex);r=h+l+p;const w={piiType:n.type,strategy:o,originalValueHash:this.hashValue(n.value),sanitizedValue:l,position:{start:n.startIndex,end:n.endIndex},timestamp:new Date};i.push(w),this.auditTrail.push(w);const x={...n,endIndex:n.startIndex+l.length};a.push(x)}return{originalText:e,sanitizedText:r,sanitizedDetections:a,actions:i,wasModified:!0}}sanitizeObject(e,t=10){if(t<=0)return{sanitizedData:e,actions:[],piiFound:!1};const s=[];let r=!1;const i=(n,o="")=>{if(typeof n=="string"){const l=this.sanitizeStringValue(n,o);return l.wasModified&&(s.push(...l.actions),r=!0),l.sanitizedValue}if(Array.isArray(n))return n.map((l,h)=>i(l,`${o}[${h}]`));if(n&&typeof n=="object"){const l={};for(const[h,p]of Object.entries(n)){const w=o?`${o}.${h}`:h;if(this.isSensitiveKey(h)){const x=this.sanitizeKeyValue(p,h,w);l[h]=x.sanitizedValue,x.wasModified&&(s.push(...x.actions),r=!0)}else l[h]=i(p,w)}return l}return n};return{sanitizedData:i(e),actions:s,piiFound:r}}getStrategyForPIIType(e){return this.config.typeStrategies[e]||this.config.defaultStrategy}updateConfig(e){Object.assign(this.config,e)}getAuditTrail(){return[...this.auditTrail]}clearAuditTrail(){this.auditTrail.length=0}getStatistics(){const e={},t={};for(const s of this.auditTrail)e[s.piiType]=(e[s.piiType]||0)+1,t[s.strategy]=(t[s.strategy]||0)+1;return{totalActions:this.auditTrail.length,actionsByType:e,actionsByStrategy:t,lastActionTime:this.auditTrail.length>0?this.auditTrail[this.auditTrail.length-1].timestamp:null}}applySanitizationStrategy(e,t,s){switch(s){case"mask":return this.maskValue(e,t);case"hash":return this.hashValue(e);case"remove":return"[REDACTED]";case"partial":return this.partialMaskValue(e,t);default:return this.maskValue(e,t)}}maskValue(e,t){if(!this.config.preserveFormat)return this.config.maskCharacter.repeat(e.length);switch(t){case"creditCard":return e.replace(/\d/g,this.config.maskCharacter);case"ssn":return e.replace(/\d/g,this.config.maskCharacter);case"phone":return e.replace(/\d/g,this.config.maskCharacter);case"email":const[s,r]=e.split("@");return`${s.length>2?s[0]+this.config.maskCharacter.repeat(s.length-2)+s[s.length-1]:this.config.maskCharacter.repeat(s.length)}@${r}`;default:return e.replace(/[a-zA-Z0-9]/g,this.config.maskCharacter)}}partialMaskValue(e,t){const s=Math.min(this.config.partialPreserveLength,Math.floor(e.length/3));if(e.length<=s*2)return this.maskValue(e,t);switch(t){case"email":const[r,i]=e.split("@");return r.length<=4?`${r[0]}${this.config.maskCharacter.repeat(r.length-1)}@${i}`:`${r.substring(0,2)+this.config.maskCharacter.repeat(r.length-4)+r.substring(r.length-2)}@${i}`;case"creditCard":const n=e.replace(/\D/g,"");if(n.length>=8){const w=n.substring(0,4)+this.config.maskCharacter.repeat(n.length-8)+n.substring(n.length-4);return e.replace(/\d/g,(x,M)=>{const C=e.substring(0,M+1).replace(/\D/g,"").length-1;return w[C]||x})}return this.maskValue(e,t);case"phone":const o=e.replace(/\D/g,"");if(o.length>=7){const w=o.substring(0,3)+this.config.maskCharacter.repeat(o.length-6)+o.substring(o.length-3);return e.replace(/\d/g,(x,M)=>{const C=e.substring(0,M+1).replace(/\D/g,"").length-1;return w[C]||x})}return this.maskValue(e,t);default:const l=e.substring(0,s),h=e.substring(e.length-s),p=this.config.maskCharacter.repeat(e.length-s*2);return l+p+h}}hashValue(e){if(this.hashCache.has(e))return this.hashCache.get(e);const t=e+this.config.hashSalt;let s=0;for(let i=0;i<t.length;i++){const a=t.charCodeAt(i);s=(s<<5)-s+a,s=s&s}const r=`[HASH:${Math.abs(s).toString(16).padStart(8,"0")}]`;return this.hashCache.set(e,r),r}sanitizeStringValue(e,t){const s=[{pattern:/password\s*[:=]\s*['"]([^'"]+)['"]/gi,type:"password",strategy:"remove"},{pattern:/api[_-]?key\s*[:=]\s*['"]([^'"]+)['"]/gi,type:"apiKey",strategy:"remove"},{pattern:/token\s*[:=]\s*['"]([^'"]+)['"]/gi,type:"jwt",strategy:"remove"}];let r=e;const i=[];let a=!1;for(const{pattern:n,type:o,strategy:l}of s){let h;for(n.lastIndex=0;(h=n.exec(e))!==null;){const p=h[0],w=h[1],x=this.applySanitizationStrategy(w,o,l),M=p.replace(w,x);r=r.replace(p,M),a=!0,i.push({piiType:o,strategy:l,originalValueHash:this.hashValue(w),sanitizedValue:x,position:{start:h.index,end:h.index+p.length},timestamp:new Date}),h[0].length===0&&n.lastIndex++}}return{sanitizedValue:r,wasModified:a,actions:i}}isSensitiveKey(e){return[/password/i,/passwd/i,/pwd/i,/secret/i,/token/i,/key/i,/auth/i,/credential/i,/ssn/i,/social/i,/credit/i,/card/i,/cvv/i,/cvc/i,/pin/i].some(s=>s.test(e))}sanitizeKeyValue(e,t,s){if(typeof e!="string")return{sanitizedValue:"[REDACTED]",wasModified:!0,actions:[{piiType:"custom",strategy:"remove",originalValueHash:this.hashValue(String(e)),sanitizedValue:"[REDACTED]",position:{start:0,end:String(e).length},timestamp:new Date}]};let r="custom";/password|passwd|pwd/i.test(t)?r="password":/token|auth/i.test(t)?r="jwt":/key/i.test(t)?r="apiKey":/ssn|social/i.test(t)?r="ssn":/credit|card/i.test(t)&&(r="creditCard");const i=this.getStrategyForPIIType(r),a=this.applySanitizationStrategy(e,r,i);return{sanitizedValue:a,wasModified:a!==e,actions:[{piiType:r,strategy:i,originalValueHash:this.hashValue(e),sanitizedValue:a,position:{start:0,end:e.length},timestamp:new Date}]}}generateSalt(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let s=0;s<32;s++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}}class ce{constructor(e,t,s,r){c(this,"piiDetector");c(this,"dataSanitizer");c(this,"consentManager");c(this,"securityPolicy");c(this,"statistics");c(this,"alerts");c(this,"scanHistory");this.piiDetector=s||new oe,this.dataSanitizer=r||new ae({defaultStrategy:"mask",typeStrategies:{creditCard:"mask",ssn:"mask",email:"partial",phone:"partial",apiKey:"remove",jwt:"remove",password:"remove",ipAddress:"hash"}}),this.consentManager=t,this.securityPolicy=e,this.alerts=new Map,this.scanHistory=new Map,this.statistics={totalScans:0,totalPIIDetected:0,totalSanitizations:0,scanPerformance:{averageTimeMs:0,minTimeMs:1/0,maxTimeMs:0},detectionStats:{},riskLevelDistribution:{public:0,internal:0,confidential:0,restricted:0},consentCompliance:{totalUsers:0,compliantScans:0,nonCompliantScans:0}},this.initializeSecurityEngine()}async scanLogEntry(e,t={}){const s=performance.now(),r=this.generateScanId();try{let i=!0;if(t.userId&&!t.skipConsentCheck){const M=t.purpose||"logging";if(this.consentManager.verifyConsent(t.userId,M).isValid)this.updateConsentComplianceStats(!0);else if(i=!1,this.updateConsentComplianceStats(!1),this.securityPolicy.requireExplicitConsent)return this.createFailedScanResult(r,e.message,["Consent not provided or invalid"])}const a=t.minConfidence||this.securityPolicy.minConfidenceThreshold,n=this.piiDetector.scanText(e.message,a),o=this.applySecurityPolicyFiltering(n),l=this.calculateRiskScore(o,e.level),h=this.classifyData(o,l);await this.generateSecurityAlerts(r,o,h,t.userId);let p;t.autoSanitize!==!1&&this.securityPolicy.autoSanitization.enabled&&i&&this.shouldAutoSanitize(o)&&(p=this.dataSanitizer.sanitizeText(e.message,o));const w=performance.now()-s,x={scanId:r,scanTimestamp:new Date,scannedText:e.message,detections:o,riskScore:l,classification:h,scanTimeMs:w,scanSuccessful:!0,scanErrors:[]};return p!=null&&p.wasModified&&(e.sanitizedMessage=p.sanitizedText),e.classification=h,this.updateStatistics(x,o),this.storeScanResult(r,x),x}catch(i){const a=performance.now()-s,n=i instanceof Error?i.message:"Unknown error";return this.createFailedScanResult(r,e.message,[n],a)}}async scanLogEntries(e,t={}){const s=[];for(let i=0;i<e.length;i+=10){const n=e.slice(i,i+10).map(l=>this.scanLogEntry(l,t)),o=await Promise.all(n);s.push(...o),i+10<e.length&&await new Promise(l=>setTimeout(l,1))}return s}updateSecurityPolicy(e){Object.assign(this.securityPolicy,e),e.autoSanitization&&this.dataSanitizer.updateConfig({typeStrategies:this.convertPolicyToSanitizerStrategies(e.autoSanitization.thresholds)})}getStatistics(){return{...this.statistics}}getSecurityAlerts(e,t,s=50){return Array.from(this.alerts.values()).filter(i=>!(e&&i.severity!==e||t!==void 0&&i.resolved!==t)).sort((i,a)=>a.timestamp.getTime()-i.timestamp.getTime()).slice(0,s)}resolveSecurityAlert(e){const t=this.alerts.get(e);return t?(t.resolved=!0,!0):!1}getScanHistory(e,t=100){if(e)return this.scanHistory.get(e)||[];const s=[];for(const r of this.scanHistory.values())s.push(...r);return s.sort((r,i)=>i.scanTimestamp.getTime()-r.scanTimestamp.getTime()).slice(0,t)}healthCheck(){const e=this.piiDetector.getPerformanceMetrics(),t=this.dataSanitizer.getStatistics(),s=this.consentManager.getConsentStatistics(),r=e.averageScanTimeMs<10?"healthy":"unhealthy",i=t.totalActions>=0?"healthy":"unhealthy",a=s.totalUsers>=0?"healthy":"unhealthy",n=this.getScanHistory(void 0,100),o=n.filter(C=>!C.scanSuccessful).length,l=n.length>0?o/n.length:0,h=Array.from(this.alerts.values()),p=h.filter(C=>C.severity==="critical"&&!C.resolved).length,w=h.filter(C=>C.severity==="high"&&!C.resolved).length,x=h.filter(C=>!C.resolved).length;let M="healthy";return p>0||l>.1||[r,i,a].includes("unhealthy")?M="unhealthy":(w>0||l>.05||this.statistics.scanPerformance.averageTimeMs>5)&&(M="degraded"),{overall:M,components:{piiDetector:r,dataSanitizer:i,consentManager:a},performance:{averageScanTimeMs:this.statistics.scanPerformance.averageTimeMs,recentErrorRate:l},alerts:{critical:p,high:w,unresolved:x}}}exportSecurityAuditReport(e,t,s){const r=`security_audit_${Date.now()}`;let i=this.getScanHistory(void 0,1e4);(t||s)&&(i=i.filter(h=>!(t&&h.scanTimestamp<t||s&&h.scanTimestamp>s)));const a=this.consentManager.getAuditLog(e,void 0,t,s),n=i.length,o=i.filter(h=>h.scanSuccessful).length,l=n>0?o/n:1;return{reportMetadata:{generatedAt:new Date,reportId:r,coverage:{fromDate:t,toDate:s,userId:e}},statistics:this.getStatistics(),alerts:this.getSecurityAlerts(),scanHistory:i,consentAudit:a,policyCompliance:{totalScans:n,compliantScans:o,complianceRate:l}}}initializeSecurityEngine(){this.consentManager.addEventListener("consentChange",t=>{console.log(`Security Engine: Consent changed for user ${t.userId}`)});const e=this.piiDetector.getSupportedPIITypes();for(const t of e)this.statistics.detectionStats[t]=0}applySecurityPolicyFiltering(e){return e.filter(t=>{if(t.confidence<this.securityPolicy.minConfidenceThreshold)return!1;const s=this.securityPolicy.autoSanitization.thresholds[t.type];return!(s!==void 0&&t.confidence<s)})}calculateRiskScore(e,t){if(e.length===0)return 0;let s=0;for(const i of e){let a=0;switch(i.type){case"creditCard":case"ssn":a=.9;break;case"password":case"apiKey":case"jwt":a=.8;break;case"email":case"phone":a=.6;break;case"ipAddress":a=.4;break;default:a=.5}s=Math.max(s,a*i.confidence)}return s*=t==="error"?1.2:t==="warn"?1.1:1,e.length>1&&(s=Math.min(1,s*(1+(e.length-1)*.1))),Math.min(1,s)}classifyData(e,t){let s="public";return t>=.8||e.some(r=>["creditCard","ssn","password"].includes(r.type))?s="restricted":t>=.6||e.some(r=>["apiKey","jwt"].includes(r.type))?s="confidential":(t>=.3||e.length>0)&&(s="internal"),{sensitivityLevel:s,detectedTypes:e.map(r=>r.type),confidence:e.length>0?Math.max(...e.map(r=>r.confidence)):0,scanTimestamp:new Date,sanitized:!1}}shouldAutoSanitize(e){return this.securityPolicy.autoSanitization.enabled?e.some(t=>{const s=this.securityPolicy.autoSanitization.thresholds[t.type];return s!==void 0&&t.confidence>=s}):!1}async generateSecurityAlerts(e,t,s,r){if(s.sensitivityLevel==="restricted"){const i={id:`alert_${Date.now()}_${Math.random().toString(36).substring(2)}`,severity:"high",type:"pii_detected",message:`High-risk PII detected in scan ${e}`,details:{scanId:e,detectedTypes:s.detectedTypes,sensitivityLevel:s.sensitivityLevel,userId:r||"unknown"},timestamp:new Date,resolved:!1};this.alerts.set(i.id,i)}if(t.length>=3){const i={id:`alert_${Date.now()}_${Math.random().toString(36).substring(2)}`,severity:"medium",type:"pii_detected",message:`Multiple PII types detected in single scan: ${t.length} types found`,details:{scanId:e,detectionCount:t.length,detectedTypes:s.detectedTypes,userId:r||"unknown"},timestamp:new Date,resolved:!1};this.alerts.set(i.id,i)}}updateStatistics(e,t){this.statistics.totalScans++,this.statistics.totalPIIDetected+=t.length;const s=this.statistics.scanPerformance.averageTimeMs,r=this.statistics.totalScans;this.statistics.scanPerformance.averageTimeMs=(s*(r-1)+e.scanTimeMs)/r,this.statistics.scanPerformance.minTimeMs=Math.min(this.statistics.scanPerformance.minTimeMs,e.scanTimeMs),this.statistics.scanPerformance.maxTimeMs=Math.max(this.statistics.scanPerformance.maxTimeMs,e.scanTimeMs);for(const i of t)this.statistics.detectionStats[i.type]=(this.statistics.detectionStats[i.type]||0)+1;this.statistics.riskLevelDistribution[e.classification.sensitivityLevel]++}updateConsentComplianceStats(e){e?this.statistics.consentCompliance.compliantScans++:this.statistics.consentCompliance.nonCompliantScans++}storeScanResult(e,t){if(this.scanHistory.has(e)||this.scanHistory.set(e,[]),this.scanHistory.get(e).push(t),this.scanHistory.size>1e3){const r=Array.from(this.scanHistory.keys())[0];this.scanHistory.delete(r)}}createFailedScanResult(e,t,s,r){return{scanId:e,scanTimestamp:new Date,scannedText:t,detections:[],riskScore:0,classification:{sensitivityLevel:"public",detectedTypes:[],confidence:0,scanTimestamp:new Date,sanitized:!1},scanTimeMs:r||0,scanSuccessful:!1,scanErrors:s}}convertPolicyToSanitizerStrategies(e){if(!e)return{};const t={};for(const[s,r]of Object.entries(e))r>=.8?t[s]="remove":r>=.6?t[s]="hash":r>=.4?t[s]="mask":t[s]="partial";return t}generateScanId(){return`scan_${Date.now()}_${Math.random().toString(36).substring(2)}`}}const le={matches:["<all_urls>","http://localhost:*/*","https://localhost:*/*"],runAt:"document_start",main:async()=>{console.log("ConsoleCapture Pro content script injected at:",window.location.href);const d=new ne,e=new ce,t=new F(d,e),s={captureEnabled:!0,capturedLevels:["log","warn","error","info"],maxLogsRetained:1e3,autoCaptureOnLoad:!1,privacy:{enablePIIDetection:!0,piiSensitivity:.8,autoSanitize:!0,dataRetentionHours:720},performance:{enableMonitoring:!0,throttleMs:0,maxMemoryMB:50},export:{defaultFormat:"json",includeMetadata:!0}};let r=null;try{await t.initialize(),t.updateConfig(s),d.on("capture:log-captured",i=>{const a=t.getCurrentSession();a&&chrome.runtime.sendMessage({type:"logs:forward",payload:{logs:[a.logs[a.logs.length-1]]}}).catch(()=>{})})}catch(i){console.error("Failed to initialize ConsoleCapture Pro:",i)}chrome.runtime.onMessage.addListener(async(i,a,n)=>{const{type:o}=i;try{switch(o){case"capture:start":return r=await t.startSession(),n({success:!0,session:{id:r.id,startTime:r.startTime,logs:r.logs}}),!0;case"capture:stop":const l=await t.stopSession();return r=null,n({success:!0,session:l?{id:l.id,startTime:l.startTime,endTime:l.endTime,logs:l.logs}:null}),!0;case"capture:status":const h=t.isCapturing(),p=t.getCurrentSession();return n({success:!0,status:{isCapturing:h,currentSession:p?{id:p.id,logs:p.logs,metadata:p.metadata}:null}}),!0;case"ping":return n({success:!0,message:"ConsoleCapture Pro content script active",url:window.location.href,initialized:!0}),!0;default:return n({success:!1,error:"Unknown message type"}),!0}}catch(l){return console.error("ConsoleCapture Pro message handling error:",l),n({success:!1,error:l instanceof Error?l.message:"Unknown error"}),!0}})}};var he=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ue(d){return d&&d.__esModule&&Object.prototype.hasOwnProperty.call(d,"default")?d.default:d}var Z={exports:{}};(function(d,e){(function(t,s){s(d)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:he,function(t){var s,r;if(!((r=(s=globalThis.chrome)==null?void 0:s.runtime)!=null&&r.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const i="The message port closed before a response was received.",a=n=>{const o={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(o).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class l extends WeakMap{constructor(g,f=void 0){super(f),this.createItem=g}get(g){return this.has(g)||this.set(g,this.createItem(g)),super.get(g)}}const h=u=>u&&typeof u=="object"&&typeof u.then=="function",p=(u,g)=>(...f)=>{n.runtime.lastError?u.reject(new Error(n.runtime.lastError.message)):g.singleCallbackArg||f.length<=1&&g.singleCallbackArg!==!1?u.resolve(f[0]):u.resolve(f)},w=u=>u==1?"argument":"arguments",x=(u,g)=>function(y,...T){if(T.length<g.minArgs)throw new Error(`Expected at least ${g.minArgs} ${w(g.minArgs)} for ${u}(), got ${T.length}`);if(T.length>g.maxArgs)throw new Error(`Expected at most ${g.maxArgs} ${w(g.maxArgs)} for ${u}(), got ${T.length}`);return new Promise((k,E)=>{if(g.fallbackToNoCallback)try{y[u](...T,p({resolve:k,reject:E},g))}catch(m){console.warn(`${u} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,m),y[u](...T),g.fallbackToNoCallback=!1,g.noCallback=!0,k()}else g.noCallback?(y[u](...T),k()):y[u](...T,p({resolve:k,reject:E},g))})},M=(u,g,f)=>new Proxy(g,{apply(y,T,k){return f.call(T,u,...k)}});let C=Function.call.bind(Object.prototype.hasOwnProperty);const O=(u,g={},f={})=>{let y=Object.create(null),T={has(E,m){return m in u||m in y},get(E,m,I){if(m in y)return y[m];if(!(m in u))return;let v=u[m];if(typeof v=="function")if(typeof g[m]=="function")v=M(u,u[m],g[m]);else if(C(f,m)){let D=x(m,f[m]);v=M(u,u[m],D)}else v=v.bind(u);else if(typeof v=="object"&&v!==null&&(C(g,m)||C(f,m)))v=O(v,g[m],f[m]);else if(C(f,"*"))v=O(v,g[m],f["*"]);else return Object.defineProperty(y,m,{configurable:!0,enumerable:!0,get(){return u[m]},set(D){u[m]=D}}),v;return y[m]=v,v},set(E,m,I,v){return m in y?y[m]=I:u[m]=I,!0},defineProperty(E,m,I){return Reflect.defineProperty(y,m,I)},deleteProperty(E,m){return Reflect.deleteProperty(y,m)}},k=Object.create(u);return new Proxy(k,T)},j=u=>({addListener(g,f,...y){g.addListener(u.get(f),...y)},hasListener(g,f){return g.hasListener(u.get(f))},removeListener(g,f){g.removeListener(u.get(f))}}),Ae=new l(u=>typeof u!="function"?u:function(f){const y=O(f,{},{getContent:{minArgs:0,maxArgs:0}});u(y)}),Y=new l(u=>typeof u!="function"?u:function(f,y,T){let k=!1,E,m=new Promise(q=>{E=function(P){k=!0,q(P)}}),I;try{I=u(f,y,E)}catch(q){I=Promise.reject(q)}const v=I!==!0&&h(I);if(I!==!0&&!v&&!k)return!1;const D=q=>{q.then(P=>{T(P)},P=>{let K;P&&(P instanceof Error||typeof P.message=="string")?K=P.message:K="An unexpected error occurred",T({__mozWebExtensionPolyfillReject__:!0,message:K})}).catch(P=>{console.error("Failed to send onMessage rejected reply",P)})};return D(v?I:m),!0}),Se=({reject:u,resolve:g},f)=>{n.runtime.lastError?n.runtime.lastError.message===i?g():u(new Error(n.runtime.lastError.message)):f&&f.__mozWebExtensionPolyfillReject__?u(new Error(f.message)):g(f)},ee=(u,g,f,...y)=>{if(y.length<g.minArgs)throw new Error(`Expected at least ${g.minArgs} ${w(g.minArgs)} for ${u}(), got ${y.length}`);if(y.length>g.maxArgs)throw new Error(`Expected at most ${g.maxArgs} ${w(g.maxArgs)} for ${u}(), got ${y.length}`);return new Promise((T,k)=>{const E=Se.bind(null,{resolve:T,reject:k});y.push(E),f.sendMessage(...y)})},xe={devtools:{network:{onRequestFinished:j(Ae)}},runtime:{onMessage:j(Y),onMessageExternal:j(Y),sendMessage:ee.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:ee.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},W={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return o.privacy={network:{"*":W},services:{"*":W},websites:{"*":W}},O(n,xe,o)};t.exports=a(chrome)}else t.exports=globalThis.browser})})(Z);var ge=Z.exports,J=ue(ge);const de={};function H(d,...e){}var me={debug:(...d)=>H(console.debug,...d),log:(...d)=>H(console.log,...d),warn:(...d)=>H(console.warn,...d),error:(...d)=>H(console.error,...d)},pe=(z=class extends Event{constructor(e,t){super(z.EVENT_NAME,{}),this.newUrl=e,this.oldUrl=t}},c(z,"EVENT_NAME",G("wxt:locationchange")),z);function G(d){const e=typeof de>"u"?"build":"content";return`${J.runtime.id}:${e}:${d}`}function fe(d){let e,t;return{run(){e==null&&(t=new URL(location.href),e=d.setInterval(()=>{let s=new URL(location.href);s.href!==t.href&&(window.dispatchEvent(new pe(s,t)),t=s)},1e3))}}}var ye=(L=class{constructor(e,t){U(this,_);U(this,V,window.self===window.top);U(this,R);U(this,N,fe(this));this.contentScriptName=e,this.options=t,se(this,R,new AbortController),$(this,V)&&X(this,_,re).call(this),this.setTimeout(()=>{X(this,_,ie).call(this)})}get signal(){return $(this,R).signal}abort(e){return $(this,R).abort(e)}get isInvalid(){return J.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(e){return this.signal.addEventListener("abort",e),()=>this.signal.removeEventListener("abort",e)}block(){return new Promise(()=>{})}setInterval(e,t){const s=setInterval(()=>{this.isValid&&e()},t);return this.onInvalidated(()=>clearInterval(s)),s}setTimeout(e,t){const s=setTimeout(()=>{this.isValid&&e()},t);return this.onInvalidated(()=>clearTimeout(s)),s}requestAnimationFrame(e){const t=requestAnimationFrame((...s)=>{this.isValid&&e(...s)});return this.onInvalidated(()=>cancelAnimationFrame(t)),t}requestIdleCallback(e,t){const s=requestIdleCallback((...r)=>{this.signal.aborted||e(...r)},t);return this.onInvalidated(()=>cancelIdleCallback(s)),s}addEventListener(e,t,s,r){var i;t==="wxt:locationchange"&&this.isValid&&$(this,N).run(),(i=e.addEventListener)==null||i.call(e,t.startsWith("wxt:")?G(t):t,s,{...r,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),me.debug(`Content script "${this.contentScriptName}" context invalidated`)}},V=new WeakMap,R=new WeakMap,N=new WeakMap,_=new WeakSet,re=function(){window.postMessage({event:L.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName},"*")},ie=function(){const e=t=>{var s,r;((s=t.data)==null?void 0:s.type)===L.SCRIPT_STARTED_MESSAGE_TYPE&&((r=t.data)==null?void 0:r.contentScriptName)===this.contentScriptName&&this.notifyInvalidated()};addEventListener("message",e),this.onInvalidated(()=>removeEventListener("message",e))},c(L,"SCRIPT_STARTED_MESSAGE_TYPE","wxt:content-script-started"),L);function B(d,...e){}var we={debug:(...d)=>B(console.debug,...d),log:(...d)=>B(console.log,...d),warn:(...d)=>B(console.warn,...d),error:(...d)=>B(console.error,...d)};(async()=>{try{const{main:d,...e}=le,t=new ye("content",e);await d(t)}catch(d){we.error('The content script "content" crashed on startup!',d)}})()})();
